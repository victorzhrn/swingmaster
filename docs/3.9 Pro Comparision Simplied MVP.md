# Pro Comparison Feature - Implementation Plan

## 1. TrajectorySelector Modifications

### Remove Elbow/Shoulder Options
```swift
enum TrajectoryOption: String, CaseIterable {
    case racket = "Racket"
    case wrist = "Wrist"  
    case off = "Off"
    // REMOVED: elbow, shoulder
}
```

### Add Compare Toggle Parameter
```swift
// Add binding to TrajectorySelector struct
@Binding var isComparing: Bool
```

### Update Body Layout
```swift
var body: some View {
    HStack(spacing: Spacing.small) { // Use design token: 8pt
        // Left: Compressed trajectory selector
        HStack(spacing: 2) {
            ForEach(TrajectoryOption.allCases, id: \.self) { option in
                SegmentButton(
                    title: option.rawValue,
                    isSelected: selectedOption == option,
                    color: option.color,
                    action: { selectOption(option) }
                )
            }
        }
        .frame(maxWidth: 160) // Reduced to fit compare toggle
        
        Spacer()
        
        // Right: Compare toggle
        CompareToggle(isComparing: $isComparing)
    }
    .padding(.horizontal, Spacing.micro) // 4pt
    .frame(height: 36)
    .background(
        RoundedRectangle(cornerRadius: 18)
            .fill(Color.white.opacity(0.05))
    )
}
```

## 2. CompareToggle Component

Create `Components/CompareToggle.swift`:

```swift
import SwiftUI

struct CompareToggle: View {
    @Binding var isComparing: Bool
    @State private var isPressed = false
    @Environment(\.theme) private var theme
    
    var body: some View {
        Button(action: toggleCompare) {
            HStack(spacing: Spacing.micro) { // 4pt spacing
                Image(systemName: "person.2.fill")
                    .font(.system(size: 13, weight: .medium))
                    .foregroundColor(labelColor)
                    .symbolRenderingMode(.hierarchical)
                
                Text("Compare")
                    .font(.system(size: 13, weight: .medium))
                    .foregroundColor(labelColor)
                
                // Custom switch aligned with design principles
                ZStack {
                    Capsule()
                        .fill(switchBackgroundColor)
                        .frame(width: 44, height: 24)
                    
                    Circle()
                        .fill(switchKnobColor)
                        .frame(width: 20, height: 20)
                        .offset(x: isComparing ? 10 : -10)
                        .animation(
                            theme.useReduceMotion ? .none : 
                            .spring(response: 0.3, dampingFraction: 0.8), // .quick spring
                            value: isComparing
                        )
                }
            }
            .padding(.horizontal, Spacing.small) // 8pt
            .padding(.vertical, 6)
            .frame(height: 44) // Minimum tap target
            .background(
                Capsule()
                    .fill(isComparing ? 
                          TennisColors.tennisGreen.opacity(0.05) : 
                          Color.clear)
            )
        }
        .buttonStyle(PlainButtonStyle())
        .scaleEffect(isPressed ? 0.96 : 1.0) // Design principle: scale(0.96) for buttons
        .onLongPressGesture(
            minimumDuration: 0,
            maximumDistance: .infinity,
            pressing: { pressing in
                withAnimation(.easeInOut(duration: 0.1)) { // .instant timing
                    isPressed = pressing
                }
            },
            perform: { }
        )
    }
    
    private func toggleCompare() {
        withAnimation(theme.useReduceMotion ? .none : .spring(response: 0.3, dampingFraction: 0.8)) {
            isComparing.toggle()
        }
        // Haptic feedback per design principles
        UIImpactFeedbackGenerator(style: .light).impactOccurred()
    }
    
    private var labelColor: Color {
        isComparing ? .white.opacity(0.95) : .white.opacity(0.6)
    }
    
    private var switchBackgroundColor: Color {
        isComparing ? 
        TennisColors.tennisGreen.opacity(0.3) : 
        Color.white.opacity(0.1)
    }
    
    private var switchKnobColor: Color {
        isComparing ? 
        TennisColors.tennisGreen : 
        Color.white.opacity(0.6)
    }
}
```

## 3. AnalysisView Modifications

### Add State Variable
```swift
@State private var isComparing: Bool = false
```

### Update TrajectorySelector Call
```swift
// In bottom control panel VStack
TrajectorySelector(
    enabledTrajectories: $enabledTrajectories,
    isComparing: $isComparing  // NEW parameter
)
.padding(.horizontal, Spacing.small) // 8pt per design system
.padding(.vertical, Spacing.small)
```

### Modify videoLayer Function for Split View
```swift
@ViewBuilder
private func videoLayer(geometry: GeometryProxy) -> some View {
    if isComparing {
        // Split view with 1pt gap
        HStack(spacing: 1) {
            // User video (left) - narrower aspect
            Group {
                if let url = videoURL {
                    VideoPlayerView(
                        url: url,
                        currentTime: $currentTime,
                        isPlaying: $isPlaying,
                        showsControls: false,
                        segmentStart: playingSegment?.startTime,
                        segmentEnd: playingSegment?.endTime,
                        onSegmentComplete: {
                            if let seg = playingSegment { 
                                currentTime = seg.endTime 
                            }
                            isPlaying = false
                            playingSegment = nil
                        }
                    )
                } else {
                    videoPlaceholder()
                }
            }
            .frame(width: geometry.size.width / 2)
            .clipped() // Handle narrower aspect ratio
            .overlay(userVideoLabel, alignment: .topLeading)
            
            // Pro video (right) - local file
            if let proURL = Bundle.main.url(
                forResource: "federer_forehand", 
                withExtension: "mp4"
            ) {
                VideoPlayerView(
                    url: proURL,
                    currentTime: .constant(0),
                    isPlaying: $isPlaying, // Sync play/pause
                    showsControls: false
                )
                .frame(width: geometry.size.width / 2)
                .clipped() // Handle narrower aspect ratio
                .overlay(proVideoLabel, alignment: .topLeading)
            } else {
                Rectangle()
                    .fill(Color.black)
                    .overlay(
                        VStack(spacing: Spacing.small) {
                            Image(systemName: "exclamationmark.triangle")
                                .font(.system(size: 28)) // .large icon
                                .foregroundColor(TennisColors.tennisYellow)
                            Text("Pro video not found")
                                .font(.caption)
                                .foregroundColor(.white.opacity(0.5))
                        }
                    )
                    .frame(width: geometry.size.width / 2)
            }
        }
    } else {
        // Original full-screen video (existing code)
        Group {
            if let url = videoURL {
                VideoPlayerView(
                    url: url,
                    currentTime: $currentTime,
                    isPlaying: $isPlaying,
                    showsControls: false,
                    segmentStart: playingSegment?.startTime,
                    segmentEnd: playingSegment?.endTime,
                    onSegmentComplete: {
                        if let seg = playingSegment { 
                            currentTime = seg.endTime 
                        }
                        isPlaying = false
                        playingSegment = nil
                    }
                )
            } else {
                videoPlaceholder()
            }
        }
    }
}

// Label overlays using design system
private var userVideoLabel: some View {
    Text("YOU")
        .font(.system(size: 11, weight: .bold)) // .caption2 bold
        .foregroundColor(.white)
        .padding(Spacing.micro) // 4pt
        .background(Color.black.opacity(0.5))
        .clipShape(RoundedRectangle(cornerRadius: 4))
        .padding(Spacing.small) // 8pt margin
}

private var proVideoLabel: some View {
    Text("PRO")
        .font(.system(size: 11, weight: .bold)) // .caption2 bold
        .foregroundColor(.white)
        .padding(Spacing.micro) // 4pt
        .background(Color.black.opacity(0.5))
        .clipShape(RoundedRectangle(cornerRadius: 4))
        .padding(Spacing.small) // 8pt margin
}
```

### Update Trajectory Overlay for Split View
```swift
// In main ZStack after videoLayer
if let shot = shots.first(where: { $0.id == selectedShotID }) {
    if isComparing {
        // Trajectory only on left (user) side
        HStack(spacing: 0) {
            TrajectoryOverlay(
                trajectoriesByType: trajectoryCache[shot.id] ?? [:],
                enabledTrajectories: enabledTrajectories,
                currentTime: currentShotRelativeTime(shot: shot),
                shotDuration: max(0, shot.endTime - shot.startTime),
                videoAspectRatio: videoAspectRatio / 2 // Adjust for narrow view
            )
            .frame(width: geometry.size.width / 2)
            .allowsHitTesting(false)
            
            Spacer()
                .frame(width: geometry.size.width / 2)
        }
    } else {
        // Original full-width trajectory
        TrajectoryOverlay(
            trajectoriesByType: trajectoryCache[shot.id] ?? [:],
            enabledTrajectories: enabledTrajectories,
            currentTime: currentShotRelativeTime(shot: shot),
            shotDuration: max(0, shot.endTime - shot.startTime),
            videoAspectRatio: videoAspectRatio
        )
        .allowsHitTesting(false)
    }
}
```

## 4. Video Placeholder Update
```swift
private func videoPlaceholder() -> some View {
    ZStack {
        Color.black
        VStack(spacing: Spacing.small) { // 8pt
            Image(systemName: "play.rectangle.fill")
                .font(.system(size: 48)) // .xlarge icon
                .foregroundColor(.white.opacity(0.3))
            Text(timeString(currentTime) + " / " + timeString(duration))
                .font(.system(size: 16, weight: .medium, design: .monospaced))
                .foregroundColor(.white.opacity(0.5))
        }
    }
    .accessibilityElement(children: .ignore)
    .accessibilityLabel("Video player")
    .accessibilityValue("Time \(timeString(currentTime)) of \(timeString(duration))")
}
```

## File Changes Summary

1. **Modify:** `TrajectorySelector.swift` - Remove options, add isComparing binding
2. **Create:** `CompareToggle.swift` - Toggle component following design system
3. **Modify:** `AnalysisView.swift` - Split view with narrow aspect handling
4. **Add:** `federer_forehand.mp4` to app bundle

## Key Design Compliance

- ✅ 44pt minimum tap targets (CompareToggle height)
- ✅ Design system colors (TennisColors)
- ✅ Design system spacing (4pt grid)
- ✅ Standard spring animations (.quick: 0.3s)
- ✅ Haptic feedback on interactions
- ✅ Respects reduce motion preference
- ✅ Handles narrow video aspect in split view
- ✅ Uses proper typography scale
- ✅ Glass morphism with correct opacity